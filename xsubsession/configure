#!/bin/sh
prefix=/usr/local
unset target
for arg in "$@"; do
	case $arg in
		--help|-h)
			cat <<EOT
configure - Configuration script for xsubsession.
  --prefix=/path    Prefix to install to.
EOT
			exit
			;;
		--build=*)
			target=${arg#--build=}
			;;
		--prefix=*)
			prefix=${arg#--prefix=}
			;;
		*=*)
			eval "$(echo $arg | cut -d= -f1)='$(echo $arg | cut -d= -f2-)'"
			;;
		*)
			if [ -z "$target" ]; then
				target="$arg"
			else
				cat <<EOT
Option "$arg" is not recognized or requires an argument.
EOT
			fi
			;;
	esac
done

if ! pkg-config libsession; then echo Install libsession!; fi
if ! pkg-config gl; then echo Install OpenGL!; fi
if ! pkg-config egl; then echo Install EGL!; fi
if ! pkg-config glu; then echo Install GLU!; fi

if [ -z "$CFLAGS" ]; then CFLAGS='-g -Wall -Werror -Wfatal-errors'; fi
SRC=$(dirname "$0")

exec 3>config
printf 'SRC="%s"\n' "$SRC" >&3
printf 'target='\'%s\''\n' "$target" >&3
printf 'prefix='\'%s\''\n' "$prefix" >&3
printf 'cflags='\'%s\''\n' "$(pkg-config --cflags libsession x11 gl egl glu)" >&3
printf 'ldflags='\'%s\''\n' "$(pkg-config --libs libsession x11 gl egl glu)" >&3
exec 3>&-

exec 3>Makefile
printf '# Generated by configure\n' >&3
printf '\n' >&3
printf 'DESTDIR=\n' >&3
printf 'CC=cc\n' >&3
printf 'CFLAGS=%s\n' "$CFLAGS" >&3
printf '\n' >&3
target() {
	printf '%s: depend\n' "$1" >&3
	printf '\t$(MAKE) -f Makefile.real %s\n' "$1" >&3
	printf '\n' "$1" >&3
}
target default
target all
target clean
target distclean
target install
target uninstall
printf 'depend:\n' >&3
printf '\t%s/depend' "$SRC" >&3
printf ' DESTDIR="${DESTDIR}"' >&3
printf ' CC="${CC}"' >&3
printf ' CFLAGS="${CFLAGS}"' >&3
printf '\n' >&3
exec 3>&-
