#!/bin/sh
. ./config
for arg in "$@"; do
	eval "$(echo $arg | cut -d= -f1)='$(echo $arg | cut -d= -f2-)'"
done

exec 3>Makefile.real
printf '# Generated by depend\n' >&3
printf '\n' >&3
printf 'default: all\n' >&3
printf '\n' >&3

# $1 - target
# $2 - dependencies separated with whitespace.
# $3 - commands. lines starting with a tab each like in a makefile.
rule() {
	if ! printf '%s' "$3" | cmp -s $1.cmd -; then
		printf '%s' "$3" > $1.cmd
	fi
	printf '%s: %s %s\n' "$1" "$1.cmd" "$2" >&3
	printf '%s' "$3" >&3
	printf '\n' >&3
}

# Get the include dependencies from the output of cc -MM or similar. Removes
# stuff before the first colon, and removes backslashes followed by newlines,
# merging lines.
# $1 - the text.
deps() {
	printf %s "${1#*:}" | sed -e :a -e '/\\$/N; s/\\\n//; ta'
}

# $1 - c source file relative to $SRC, $2 - flags
compile() {
	F=${1%.c}
	D=$(deps "`cat $F.d 2>/dev/null`")
	for i in $D; do printf "%s:\n\n" "$i" >&3; done
	rule $F.o "$SRC/$F.c $D" \
"	$CC $CFLAGS $2 -c -o $F.o $SRC/$F.c
	$CC $CFLAGS $2 -M $SRC/$F.c > $F.d
"
}

# Copy directory structure. Needed in this script (before make) because the
# various *.cmd files are created here.

mkdir -p lib
mkdir -p setuid

LIBOBJ=''
for i in $SRC/lib/*.c; do
	f=${i#$SRC/}
	compile $f '-fPIC'
	LIBOBJ="$LIBOBJ ${f%.c}.o"
done

SUOBJ=''
for i in $SRC/setuid/*.c; do
	f=${i#$SRC/}
	compile $f
	SUOBJ="$SUOBJ ${f%.c}.o"
done

rule libsession.so "$LIBOBJ $SRC/lib/libsession.version" \
"	$CC -shared $LDFLAGS -o libsession.so $LIBOBJ -Wl,--version-script=$SRC/lib/libsession.version
"

rule session-master "$SUOBJ" \
"	$CC $LDFLAGS -pthread -o session-master $SUOBJ
"

rule libsession.pc "$SRC/generate_pc.sh" \
"	$SRC/generate_pc.sh
"

printf 'install:\n' >&3
printf '\tinstall session-master %s/bin\n' "$prefix" >&3
printf '\tchmod gu+s %s/bin/session-master\n' "$prefix" >&3
printf '\tcp libsession.so %s/lib/%s\n' "$prefix" "$target" >&3
printf '\tcp libsession.pc %s/lib/%s/pkgconfig\n' "$prefix" "$target" >&3
printf '\tinstall -d %s/include/session\n' "$prefix" >&3
printf '\tcp %s %s/include/session/\n' "$(deps "$(cc -MM "$SRC/lib/session.h")")" $prefix >&3
printf '\n' >&3
printf 'uninstall:\n' >&3
printf '\trm %s/bin/session-master\n' "$prefix" >&3
printf '\trm %s/lib/%s/libsession.so\n' "$prefix" "$target" >&3
printf '\trm %s/lib/%s/pkgconfig/libsession.pc\n' "$prefix" "$target" >&3
printf '\trm -r %s/include/session\n' "$prefix" >&3
printf '\n' >&3
printf 'all: libsession.so session-master libsession.pc\n' >&3
printf '\n' >&3
exec 3>&-
